\section{Code Weaknesses and Vulnerabilities}
We now present a selection of the most dangerous and common software weaknesses, to illustrate common coding patterns that lead to security vulnerabilities and to guide analysis and testing efforts.
Knowing this classification can help us with:
\begin{itemize}
    \item \textbf{Conduct effective testing}: we know what to search while testing, so we can prioritize some issues, over others;
    \item \textbf{Improve development process}: know solutions (ex: patterns, guidelines) to help developers improve their software, avoiding the introduction of weaknesses;
    \item \textbf{Drive bug-fixing}: prioritize the issues to solve, helping also to understand how to fix it.
\end{itemize}

\subsection{Common Weakness Enumeration (CWE)}
\subsubsection*{Use-After-Free (CWE-416)}
The software reuses or references memory, after it has been freed. At some point afterwards, the memory may be allocated to another pointer. Any operation using the original pointer is no longer valid.
\begin{figure}[H]
\begin{lstlisting}[language=C]
    char* ptr = (char*)malloc (SIZE);
    if(err){
        abrt = 1;
        free(ptr);
    }
    if(abrt){
        //Accessing a pointer 
        logError("operation aborted before commit", ptr);
    }
\end{lstlisting}
\end{figure}
Use-after-free can be found also when other resources, such as files or network connections are mismanaged.
\begin{itemize}
    \item \textbf{Cause}: access to a pointer after it has been freed;
    \item \textbf{Prevention}: once freed, all pointers should be set to NULL;
    \item \textbf{Detection}: using static analysis or fuzzing.
\end{itemize}

\subsubsection*{Heap-based Buffer Overflow (CWE-122)}
A particular case of the buffer overflow, where the buffer is allocated in the heap portion of the memory. This means that the buffer was allocated using \verb|malloc()|.
\begin{figure}[H]
\begin{lstlisting}[language=C]
    #define BUFSIZE 4
    int main(int argc, char **argv) {
        char *buf;
        buf = (char *)malloc(sizeof(char)*BUFSIZE);
        strcpy(buf, argv[1]);
    }
\end{lstlisting}
\end{figure}
The problem here is caused by the function \verb|strcpy()|, which has no limits on the length of the element that should be copied to the buffer.
\begin{itemize}
    \item \textbf{Cause}: writing more data than the allocated buffer size;
    \item \textbf{Prevention}: Other equivalents, but safer functions should be used. For example \verb|strncpy()| takes as an argument the maximum number of characters that should be copied.
    Also, automatic buffer overflow detection mechanisms can be used;
    \item \textbf{Detection}: Using static analysis or fuzzing.
\end{itemize}

\subsubsection*{Out-of-bounds Write (CWE-787)}
The software writes data past the end, or before the beginning of the intended buffer.

\begin{figure}[H]
\begin{lstlisting}[language=C]
    int id_sequence[3];
    
    id_sequence[0] = 123;
    id_sequence[1] = 234;
    id_sequence[2] = 345;
    id_sequence[3] = 456;
\end{lstlisting}
\end{figure}
\begin{itemize}
    \item \textbf{Cause}: writing data outside the boundaries of a buffer;
    \item \textbf{Prevention}: Always verify that the buffer is as large as specified and that its boundaries are respected.
    \item \textbf{Detection}: Using static analysis and dynamic analysis.
\end{itemize}

\subsubsection*{Improper Input Validation (CWE-20)}
The software receives input values, but it does not validate or incorrectly validates them. In case of no validation, unintended input values can alter the program control flow.

\begin{figure}[H]
\begin{lstlisting}[language=C]
    public static final double price = 20.00;
    int quantity = currentUser.getAttribute("quantity");
    double total = price * quantity;
    chargeUser(total);
\end{lstlisting}
\end{figure}
In this example, if the user inputs a negative number for the quantity, it can lead to an account credit instead of a debit.
\begin{itemize}
    \item \textbf{Cause}: missing or incorrect validation of input data;
    \item \textbf{Prevention}: Always validate input data, both on client-side and server-side;
    \item \textbf{Detection}: Using static analysis or dynamic analysis.
\end{itemize}

\subsubsection*{Improper Neutralization of Special Elements used in an OS Command (CWE-78)}
The software constructs an OS command using an external input, but it does not neutralize special elements that could modify the intended OS command.

\begin{figure}[H]
\begin{lstlisting}[language=php]
    $userName = $_POST["user"];
    $command = 'ls -l /home/' . $userName;
    system($command);
\end{lstlisting}
\end{figure}
This code takes the name of a user and lists the content of the user directory. There is no check on the variable \verb|$userName|, that could contain an arbitrary OS command such as: \verb|";rm -rf /"|. Since the \verb|;| works as a command separator in Linux, such input would delete the entire file system.
\begin{itemize}
    \item \textbf{Cause}: inclusion of untrusted input in an OS command, without neutralizing special elements;
    \item \textbf{Prevention}: Use library calls rather than external processes and try to block the user from using semi-colons or other special characters.
    \item \textbf{Detection}: Using dynamic analysis.
\end{itemize}

\subsubsection*{De-serialization of Untrusted Data (CWE-502)}
The software deserializes untrusted data without verifying that the resulting data will be valid.

\begin{figure}[H]
\begin{lstlisting}[language=Java]
    try {
        File file = new File("object.obj");
        ObjectInputStream in = new ObjectInputStream(new FileInputStream(file));
        javax.swing.JButton button = (javax.swing.JButton) in.readObject();
        in.close();
    }
\end{lstlisting}
\end{figure}
The code deserializes an object from a file, received from a UI button and does not verify the source or contents of the received file.
\begin{itemize}
    \item \textbf{Cause}: deserialization of untrusted data, without verifying its validity;
    \item \textbf{Prevention}: When deserializing data, a new object should be populated, rather than just deserializing it.
    \item \textbf{Detection}: Using static analysis.
\end{itemize}

\subsubsection*{Server-Side Request Forgery (CWE-918)}
\label{Server-Side-Request-Forgery}
A security vulnerability in a server A allows an attacker to cause the server-side application to make requests to an unintended location (i.e., another server B or service). 
\\The attackerâ€™s request is sent from the back end of the server, so the target service believes it came from a legitimate source. 
Attackers can bypass access controls (i.e., firewalls) that prevent direct attacks on the target server by exploiting trusted relationships between servers. 
The compromised server can also be used as a proxy to conduct port scanning of internal hosts or to access restricted URLs and documents.
\begin{itemize}
    \item \textbf{Cause}: Misconfigured server settings or lack of proper input validation;
    \item \textbf{Prevention}: 
    \begin{itemize}
        \item Limit outbound traffic from the application server.
        \item Build a whitelist of trusted domains and IP addresses.
        \item Sanitize user input to prevent potential risks.
    \end{itemize}
    \item \textbf{Detection}: Using dynamic analysis or vulnerability scanning.
\end{itemize}

\subsubsection*{Access of Resource Using Incompatible Type (CWE-843)}
The software initializes a resource such as a pointer, object or variable, using one type, but later accesses that resource using a type that is incompatible with the original type. Type confusion can lead to out-of-bounds memory access.

\begin{figure}[H]
\begin{lstlisting}[language=php]
    $value = $_GET['value'];
    $sum = $value + 5;
    echo "value parameter is '$value'<p>";
    echo "SUM is $sum";
\end{lstlisting}
\end{figure}
An attacker could supply an input string such as \verb|value[]=123|. From that point, \verb|value| is treated as an array type, causing an error when the sum is calculated.
\begin{itemize}
    \item \textbf{Cause}: accessing a resource using a type incompatible with the original type;
    \item \textbf{Prevention}: Attention to implicit and explicit type conversion;
    \item \textbf{Detection}: Using static analysis.
\end{itemize}

\subsubsection*{Improper Limitation of a Pathname to a Restricted Directory (CWE-22)}
The product uses an external input to construct a pathname for a file or directory, located into a restricted parent directory. Without the neutralization of special elements, the path can relate to a different location, not supposed to be accessible.

\begin{figure}[H]
\begin{lstlisting}[language=Java]
    String path = getInputPath();
    if (path.startsWith("/safe_dir/")){
        File f = new File(path);
        f.delete()
    }
\end{lstlisting}
\end{figure}
\begin{itemize}
    \item \textbf{Cause}: inclusion of untrusted input in a file or directory path, without neutralizing special elements;
    \item \textbf{Prevention}: Always assume inputs are malicious. Validate and sanitize user input, to avoid directory traversal attacks.
    When the set of acceptable objects, such as filenames or URLs, is limited and known, create a mapping from a set of fixed input values to the actual filenames or URLs, rejecting all the other inputs;
    \item \textbf{Detection}: Using static analysis or dynamic analysis.
\end{itemize}

\subsubsection*{Missing Authentication for Critical Function (CWE-306)}
The product does not perform any authentication for a functionality that requires a provable user identity.
\begin{itemize}
    \item \textbf{Cause}: missing authentication for a critical function;
    \item \textbf{Prevention}: Where possible, avoid using custom authentication routines. Instead, consider using authentication capabilities as provided by libraries or frameworks;
    \item \textbf{Detection}: Using static analysis or dynamic analysis.
\end{itemize}

\subsection{Most common security risks}
OWASP is an open source project, providing guides, guidelines and suggestions to develop and test secure applications. Its Top-10 lists the most critical security risks for web applications.
In the following, we present the OWASP Top-10 of 2021.

\subsubsection*{Broken Access Control (A01-2021)}
Access control enforces policy such that users cannot act outside their intended permissions. 
Its failure leads to unauthorized information disclosure, modification, or destruction.
\begin{itemize}
    \item \textbf{Example:} An application allows users to access other users' accounts by simply changing a parameter in the URL.
    \begin{figure}[H]
    \begin{lstlisting}[language=Java]
    //Trying to access using this url
    //https://example.com/app/accountInfo?acct=myacct
    //myacct is a "reference" to an account
    PreparedStatement pstmt = connect.prepareStatement(query);
    // Set the acct parameter, from the request
    pstmt.setString(1, request.getParameter("acct"));
    ResultSet results = pstmt.executeQuery();
    \end{lstlisting}
    \end{figure}
    If an attacker modifies the browser's \verb|acct| parameter with whatever account number they want, the attacker can access any other user's account.
    \item \textbf{Prevention}: Implement proper access controls standars, such as the least-privilege principle and deny by default.
\end{itemize}

\subsubsection*{Cryptography Failures (A02-2021)}
Violation of the protection needed for exchanged data. Data can't be transmitted in clear text, but should always be encrypted, using properly set cryptographic algorithms.
\begin{itemize}
    \item \textbf{Example:} An application correctly encrypts credit card numbers in a database before storing them. 
    Data is automatically decrypted once retrieved, allowing an SQL injection to retrieve all the information in clear text.
    \item \textbf{Prevention:} Always use proper encryption mechanisms, with a correct setting.
\end{itemize}

\subsubsection*{Injection (A03-2021)}
An application is vulnerable to this type of attack when user input data is not validated by the application before using it as command parameters.
\begin{itemize}
    \item \textbf{Example:} An application constructs SQL queries using user input directly.  
    \begin{figure}[H]
    \begin{lstlisting}[language=Java]
    String query = "SELECT * FROM accounts WHERE custID='" +
        request.getParameter("id") + "'";
    \end{lstlisting}
    \end{figure}
    If the attacker manages to set the \verb|id| parameter, for example to \verb|' OR '1'='1|, the query will return all the records from the account table.
    \item \textbf{Prevention:} Use parameterized queries (prepared statements) or stored procedures, to separate code from data. Always validate and sanitize user input.
\end{itemize}

\subsubsection*{Insecure design (A04-2021)}
Insecure design concerns weaknesses related to missing or ineffective control design. 
Note that this is different from implementation flaws, as it relates to design and architectural flaws.
\begin{itemize}
    \item \textbf{Example:} An application implements a password recovery workflow that relies solely on easily guessable personal information to verify user identity.
    \item \textbf{Prevention:} Adopt secure design methodologies, such as threat modeling and secure design patterns.
\end{itemize}

\subsubsection*{Security Misconfiguration (A05-2021)}
Refers to a variety of situations, such as:
\begin{itemize}
    \item Missing appropriate security hardening or improperly configured permissions;
    \item Unnecessary features installed (ex: ports, accounts, privileges);
    \item Default account, with default passwords;
    \item Missing error handling, revealing stack traces or other important information;
    \item Out of date software.
\end{itemize}
To prevent security misconfiguration, a secure installation process should be implemented.
All the configurations should be defined, implemented and documented, to be maintained over time.

\subsubsection*{Vulnerable and Outdated Components (A06-2021)}
The components of a software can be vulnerable, unsupported, or out of date.
To prevent this issue, the following practices should be adopted:
\begin{itemize}
    \item \textbf{Remove unused dependencies}, unnecessary features, components and documentation;
    \item Continuously \textbf{monitor} the \textbf{versions} of both client and server components and their dependencies;
    \item Obtain components only from \textbf{official sources}.
\end{itemize}

\subsubsection*{Identification and Authentication Failures (A07-2021)}
Authentication, confirmation of user identity and session management are critical to protect against authentication-related attacks.
To prevent this issue, the following practices should be adopted:
\begin{itemize}
    \item Implement proper identification and authentication processes (ex: MFA, to prevent brute force, stolen credential reuse attacks);
    \item Do not permit the usage of weak passwords;
    \item Use a server-side, secure session manager.
\end{itemize}

\subsubsection*{Software and Data Integrity Failures (A08-2021)}
Relates to code and infrastructure that does not protect against integrity violations. 
An example is the use of untrusted CI/CD pipelines, or the use of unverified software libraries. 
Attackers can exploit these weaknesses to inject malicious code into the application.
\\To prevent this issue, we should always ensure that all dependencies come from trusted sources, and verify their integrity.

\subsubsection*{Security Logging and Monitoring Failures (A09-2021)}
It relates to the logging and monitoring capability to detect security breaches. 
You will make yourself vulnerable to information leakage by making logging and alerting events visible to the users.
It's important to implement proper logging and monitoring mechanisms, to detect security incidents, without exposing sensitive information.

\subsubsection*{Server-Side Request Forgery (A10-2021)}
Already discussed in Section~\ref{Server-Side-Request-Forgery}.